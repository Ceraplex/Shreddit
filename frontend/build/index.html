<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shreddit ‚Äî Dashboard</title>
    <style>
        :root { color-scheme: light dark; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; margin: 0; }
        header { padding: 1rem; background: #222; color: #fff; display:flex; align-items:center; justify-content:space-between; }
        main { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; padding: 1rem; }
        .card { background: #ffffff; border: 1px solid #0002; border-radius: 8px; padding: 1rem; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { padding: .75rem; border-bottom: 1px solid #0001; display: flex; flex-direction: column; align-items: stretch; gap: .5rem; }
        .muted { opacity: .8; }
        .toolbar { display: flex; gap: .5rem; margin-bottom: .75rem; }
        input, button { padding: .5rem .75rem; }
        .title { font-weight: 600; }
        .row { display: flex; align-items: center; gap: .5rem; }
        .date { font-variant-numeric: tabular-nums; }
        .space-between { justify-content: space-between; width: 100%; }
        .title-btn { background: none; border: none; color: inherit; cursor: pointer; padding: 0; font: inherit; text-align: left; }
        .details { display: none; margin-top: .5rem; padding-top: .5rem; border-top: 1px solid #0002; }
        .right { display:flex; gap:.5rem; align-items:center; }

        /* Theme toggle styles */
        #themeToggle { padding: .4rem .6rem; border-radius: 6px; border: 1px solid #0002; background: transparent; color: inherit; cursor: pointer; }

        /* Light/Dark Theme Overrides */
        body.theme-light { background: #f7f7f7; color: #111; }
        body.theme-dark { background: #121212; color: #eee; }

        body.theme-light header { background: #f0f0f0; color: #111; }
        body.theme-dark header { background: #222; color: #fff; }

        body.theme-light .card { background: #ffffff; border-color: #0002; }
        body.theme-dark .card { background: #1e1e1e; border-color: #ffffff22; }

        body.theme-light li { border-bottom-color: #0002; }
        body.theme-dark li { border-bottom-color: #ffffff22; }

        body.theme-light .details { border-top-color: #0002; }
        body.theme-dark .details { border-top-color: #ffffff33; }

        /* Form controls and buttons theming */
        input, select, textarea, button { font: inherit; }
        button:not(.title-btn) { cursor: pointer; }

        /* Light theme controls */
        body.theme-light input,
        body.theme-light select,
        body.theme-light textarea {
            background: #ffffff;
            color: #111;
            border: 1px solid #0002;
            border-radius: 6px;
        }
        body.theme-light button:not(.title-btn) {
            background: #f7f7f7;
            color: #111;
            border: 1px solid #0002;
            border-radius: 6px;
        }
        body.theme-light button:not(.title-btn):hover {
            background: #ececec;
        }

        /* Dark theme controls */
        body.theme-dark input,
        body.theme-dark select,
        body.theme-dark textarea {
            background: #2a2a2a;
            color: #eee;
            border: 1px solid #ffffff22;
            border-radius: 6px;
        }
        body.theme-dark button:not(.title-btn) {
            background: #2a2a2a;
            color: #eee;
            border: 1px solid #ffffff22;
            border-radius: 6px;
        }
        body.theme-dark button:not(.title-btn):hover {
            background: #333333;
        }

        /* Focus styles for accessibility */
        body.theme-light input:focus,
        body.theme-light select:focus,
        body.theme-light textarea:focus,
        body.theme-light button:not(.title-btn):focus {
            outline: 2px solid #6ca8ff;
            outline-offset: 1px;
        }
        body.theme-dark input:focus,
        body.theme-dark select:focus,
        body.theme-dark textarea:focus,
        body.theme-dark button:not(.title-btn):focus {
            outline: 2px solid #5b8cff;
            outline-offset: 1px;
        }

        /* Ensure theme toggle border adapts per theme */
        body.theme-dark #themeToggle { border-color: #ffffff22; }
        body.theme-light #themeToggle { border-color: #0002; }

        /* File input ‚ÄúDurchsuchen‚Äù button theming */
        /* Modern browsers */
        body.theme-light input[type="file"]::file-selector-button {
            background: #f7f7f7;
            color: #111;
            border: 1px solid #0002;
            border-radius: 6px;
            padding: .5rem .75rem;
            margin-right: .5rem;
            cursor: pointer;
        }
        body.theme-light input[type="file"]::file-selector-button:hover { background: #ececec; }
        body.theme-light input[type="file"]::file-selector-button:focus {
            outline: 2px solid #6ca8ff;
            outline-offset: 1px;
        }
        body.theme-dark input[type="file"]::file-selector-button {
            background: #2a2a2a;
            color: #eee;
            border: 1px solid #ffffff22;
            border-radius: 6px;
            padding: .5rem .75rem;
            margin-right: .5rem;
            cursor: pointer;
        }
        body.theme-dark input[type="file"]::file-selector-button:hover { background: #333333; }
        body.theme-dark input[type="file"]::file-selector-button:focus {
            outline: 2px solid #5b8cff;
            outline-offset: 1px;
        }

        /* WebKit fallback */
        body.theme-light input[type="file"]::-webkit-file-upload-button {
            background: #f7f7f7;
            color: #111;
            border: 1px solid #0002;
            border-radius: 6px;
            padding: .5rem .75rem;
            margin-right: .5rem;
            cursor: pointer;
        }
        body.theme-light input[type="file"]::-webkit-file-upload-button:hover { background: #ececec; }
        body.theme-light input[type="file"]::-webkit-file-upload-button:focus {
            outline: 2px solid #6ca8ff;
            outline-offset: 1px;
        }
        body.theme-dark input[type="file"]::-webkit-file-upload-button {
            background: #2a2a2a;
            color: #eee;
            border: 1px solid #ffffff22;
            border-radius: 6px;
            padding: .5rem .75rem;
            margin-right: .5rem;
            cursor: pointer;
        }
        body.theme-dark input[type="file"]::-webkit-file-upload-button:hover { background: #333333; }
        body.theme-dark input[type="file"]::-webkit-file-upload-button:focus {
            outline: 2px solid #5b8cff;
            outline-offset: 1px;
        }
    </style>
</head>
<body>
<header>
    <h1>Shreddit ‚Äî Documents</h1>
    <div class="right">
        <button id="themeToggle" aria-label="Toggle theme">üåô</button>
        <span id="userInfo" class="muted" style="display:none"></span>
        <button id="logoutBtn" style="display:none">Logout</button>
    </div>
</header>
<main>
    <section class="card" id="authCard" style="grid-column:1/3;">
        <h2>Log In or Register</h2>
        <form id="authForm">
            <div class="row">
                <input id="authUsername" placeholder="Username" required />
            </div>
            <div class="row">
                <input id="authPassword" type="password" placeholder="Password" required />
            </div>
            <div class="row" style="gap:.5rem">
                <button id="loginBtn">Log In</button>
                <button id="registerBtn" type="button">Register</button>
            </div>
            <div id="authMsg" class="muted" style="margin-top:.5rem"></div>
        </form>
    </section>

    <section class="card" id="listCard" style="display:none;">
        <div class="toolbar">
            <input id="search" placeholder="Filter by title..." />
            <input id="searchFull" placeholder="Full-text search (title/ocr/summary)" />
            <button id="searchFullBtn" type="button">Search text</button>
            <button id="refresh">Refresh</button>
            <span id="searchStatus" class="muted"></span>
        </div>
        <ul id="list"></ul>
    </section>
    <section class="card" id="upload" style="display:none;">
        <h2>Upload Document</h2>
        <form id="uploadForm">
            <div class="row">
                <input id="title" name="title" placeholder="Title (optional)" />
            </div>
            <div class="row">
                <input id="file" name="file" type="file" accept="application/pdf,.pdf" required />
            </div>
            <div class="row">
                <button type="submit">Upload PDF</button>
            </div>
            <div class="row">
                <small class="muted">Only PDF files are allowed.</small>
            </div>
        </form>
        <div id="msg" class="muted" style="margin-top:.5rem"></div>
    </section>
</main>
<script src="/assets/api.js"></script>
<script>
    // Auth / UI gating
    const authCard = document.getElementById('authCard');
    const listCard = document.getElementById('listCard');
    const uploadCard = document.getElementById('upload');
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    const themeToggle = document.getElementById('themeToggle');

    function isLoggedIn() {
        try { return !!localStorage.getItem('jwt'); } catch (_) { return false; }
    }
    function getUsername() {
        try { return localStorage.getItem('username') || ''; } catch (_) { return ''; }
    }
    function setAuth(token, username) {
        try {
            localStorage.setItem('jwt', token);
            localStorage.setItem('username', username || '');
        } catch (_) {}
        applyAuthState();
    }
    function clearAuth() {
        try {
            localStorage.removeItem('jwt');
            localStorage.removeItem('username');
        } catch (_) {}
        applyAuthState();
    }
    function applyAuthState() {
        const logged = isLoggedIn();
        authCard.style.display = logged ? 'none' : 'block';
        listCard.style.display = logged ? 'block' : 'none';
        uploadCard.style.display = logged ? 'block' : 'none';
        userInfo.style.display = logged ? 'inline' : 'none';
        logoutBtn.style.display = logged ? 'inline-block' : 'none';
        if (logged) {
            userInfo.textContent = 'Signed in as ' + getUsername();
            load();
        } else {
            // clear list
            const listEl = document.getElementById('list');
            if (listEl) listEl.innerHTML = '';
        }
    }
    logoutBtn.addEventListener('click', () => { clearAuth(); });

    // Theme toggle
    function applyTheme(theme) {
        const mode = theme === 'dark' ? 'dark' : 'light';
        document.body.classList.remove('theme-light', 'theme-dark');
        document.body.classList.add('theme-' + mode);
        if (themeToggle) { themeToggle.textContent = mode === 'dark' ? '‚òÄÔ∏è' : 'üåô'; }
    }
    function loadTheme() {
        let t = 'light';
        try {
            t = localStorage.getItem('theme') || 'light';
        } catch (_) {}
        applyTheme(t);
    }
    themeToggle?.addEventListener('click', () => {
        const isDark = document.body.classList.contains('theme-dark');
        const next = isDark ? 'light' : 'dark';
        try { localStorage.setItem('theme', next); } catch (_) {}
        applyTheme(next);
    });

    // Auth handlers
    const authForm = document.getElementById('authForm');
    const authUsername = document.getElementById('authUsername');
    const authPassword = document.getElementById('authPassword');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const authMsg = document.getElementById('authMsg');

    loginBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await doAuth('/api/auth/login');
    });
    registerBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await doAuth('/api/auth/register');
    });
    async function doAuth(url) {
        authMsg.textContent = '';
        const username = authUsername.value.trim();
        const password = authPassword.value;
        if (!username || !password) { authMsg.textContent = 'Enter username and password.'; return; }
        try {
            const res = await apiFetch(url, { method: 'POST', body: JSON.stringify({ username, password }) });
            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                authMsg.textContent = data.error || 'Authentication failed';
                return;
            }
            const data = await res.json();
            setAuth(data.token, data.username);
            authForm.reset();
        } catch (e) {
            console.error(e);
            authMsg.textContent = 'Network error';
        }
    }

    // Documents/dashboard (same as before)
    const listEl = document.getElementById('list');
    const searchEl = document.getElementById('search');
    const searchFullEl = document.getElementById('searchFull');
    const searchFullBtn = document.getElementById('searchFullBtn');
    const searchStatus = document.getElementById('searchStatus');
    const refreshBtn = document.getElementById('refresh');
    const form = document.getElementById('uploadForm');
    const titleInput = document.getElementById('title');
    const fileInput = document.getElementById('file');
    const msgEl = document.getElementById('msg');
    let docs = [];

    async function load() {
        if (!isLoggedIn()) return;
        try {
            const res = await apiFetch('/api/documents');
            if (res.status === 403) {
                // delete jwt token
                console.log("deleting jwt");
                localStorage.removeItem('jwt');
                // send user to login page
                applyAuthState();
                console.log("should show login");
            }
            if (!res.ok) throw new Error('Failed to load documents');
            docs = await res.json();
            render();
        } catch (e) {
            console.error(e);
            listEl.innerHTML = `<li class="muted">Error loading documents</li>`;
        }
    }

    function render() {
        const q = (searchEl?.value || '').toLowerCase();
        const filtered = docs.filter(d => (d.title || '').toLowerCase().includes(q));
        listEl.innerHTML = '';
        if (!filtered.length) {
            listEl.innerHTML = `<li class="muted">No documents</li>`;
            return;
        }
        for (const d of filtered) {
            console.log('doc', d.id, 'status:', d.summaryStatus, 'summary:', d.summary);
            const li = document.createElement('li');
            const left = document.createElement('div');
            left.className = 'row';
            left.innerHTML = `<button class="title-btn title" data-id="${d.id}">${escapeHtml(d.title || '(untitled)')}</button><span class="muted date">${formatDate(d.createdAt)}</span>`;

            const del = document.createElement('button');
            del.textContent = 'Delete';
            del.onclick = async () => {
                if (!confirm('Delete this document?')) return;
                const res = await apiFetch(`/api/documents/${d.id}`, { method: 'DELETE' });
                if (res.ok) {
                    docs = docs.filter(x => x.id !== d.id);
                    render();
                } else {
                    alert('Delete failed');
                }
            };

            const headerRow = document.createElement('div');
            headerRow.className = 'row space-between';
            headerRow.appendChild(left);

            // Create a container for the buttons
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'row';
            buttonContainer.style.gap = '0.5rem';
            // Summary availability: OK status or non-empty summary text
            const hasSummary = d && (d.summaryStatus === 'OK' || (typeof d.summary === 'string' && d.summary.trim().length > 0));
            // Add summary button based on status/availability
            if (hasSummary) {
                const dlSummary = document.createElement('button');
                dlSummary.textContent = 'Download Summary';
                dlSummary.onclick = () => handleDownloadSummary(d.id, d.summary);
                buttonContainer.appendChild(dlSummary);
            } else if (d.summaryStatus === 'PENDING') {
                const dlSummaryPending = document.createElement('button');
                dlSummaryPending.textContent = 'Summary pending‚Ä¶';
                dlSummaryPending.disabled = true;
                buttonContainer.appendChild(dlSummaryPending);
            } // FAILED or missing -> hide button
            // Add delete button to the container
            buttonContainer.appendChild(del);

            // Add the button container to the header row
            headerRow.appendChild(buttonContainer);

            const details = document.createElement('div');
            details.className = 'details';
            details.dataset.loaded = 'false';

            const titleBtn = headerRow.querySelector('.title-btn');
            titleBtn.addEventListener('click', async () => {
                if (details.style.display === 'block') {
                    details.style.display = 'none';
                    return;
                }
                if (details.dataset.loaded !== 'true') {
                    try {
                        const res = await apiFetch(`/api/documents/${d.id}`);
                        if (!res.ok) {
                            details.innerHTML = `<div class="muted">Details could not be loaded.</div>`;
                        } else {
                            const doc = await res.json();
                            const hasSummary = doc.summaryStatus === 'OK';
                            const summaryBtnId = `dl-summary-${doc.id}`;
                            const summaryBlock = hasSummary
                                ? `<div><strong>Summary:</strong><br><pre style="white-space:pre-wrap">${escapeHtml(doc.summary || '')}</pre><div class="row" style="margin-top:.5rem;"><button id="${summaryBtnId}" data-id="${doc.id}">Download summary</button></div></div>`
                                : `<div class="muted"><strong>Summary:</strong> ${escapeHtml(doc.summaryStatus || 'PENDING')}</div>`;
                            details.innerHTML = `
                <div><strong>Title:</strong> ${escapeHtml(doc.title || '(untitled)')}</div>
                <div><strong>Uploaded:</strong> ${formatDate(doc.createdAt)}</div>
                <div><strong>ID:</strong> ${doc.id}</div>
                ${summaryBlock}

                <!-- Comments section -->
                <div style="margin-top: 1rem; border-top: 1px solid #0002; padding-top: 1rem;">
                  <h3>Comments</h3>
                  <div id="comments-${doc.id}" class="comments-list">
                    <div class="muted">Loading comments...</div>
                  </div>

                  <!-- Comment form -->
                  <div style="margin-top: 1rem;">
                    <h4>Add a comment</h4>
                    <div class="row" style="flex-direction: column; align-items: flex-start;">
                      <textarea id="comment-text-${doc.id}" style="width: 100%; min-height: 80px; margin-bottom: 0.5rem;" placeholder="Write your comment here..."></textarea>
                      <button id="add-comment-btn-${doc.id}" data-document-id="${doc.id}">Add Comment</button>
                    </div>
                  </div>
                </div>
              `;
                            details.dataset.loaded = 'true';
                            const dlBtn = details.querySelector(`#${summaryBtnId}`);
                            if (dlBtn) {
                                dlBtn.addEventListener('click', () => handleDownloadSummary(doc.id, doc.summary));
                            }

                            // Load comments for this document
                            loadComments(doc.id);

                            // Add event listener for the comment button
                            const addCommentBtn = details.querySelector(`#add-comment-btn-${doc.id}`);
                            if (addCommentBtn) {
                                addCommentBtn.addEventListener('click', () => addComment(doc.id));
                            }
                        }
                    } catch (e) {
                        console.error(e);
                        details.innerHTML = `<div class="muted">Error loading details.</div>`;
                    }
                }
                details.style.display = 'block';
            });

            li.appendChild(headerRow);
            li.appendChild(details);
            listEl.appendChild(li);
        }
    }

    function formatDate(dt) {
        if (!dt) return '(no date)';
        try {
            const d = typeof dt === 'string' ? new Date(dt) : dt;
            if (Number.isNaN(d.getTime())) return '(no date)';
            return d.toLocaleString();
        } catch (_) { return '(no date)'; }
    }

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    async function handleDownloadSummary(documentId, inlineSummary) {
        try {
            if (inlineSummary && inlineSummary.trim().length > 0) {
                const blobInline = new Blob([inlineSummary], { type: 'text/plain;charset=utf-8' });
                const urlInline = window.URL.createObjectURL(blobInline);
                const aInline = document.createElement('a');
                aInline.href = urlInline;
                aInline.download = `summary-${documentId}.txt`;
                document.body.appendChild(aInline);
                aInline.click();
                aInline.remove();
                window.URL.revokeObjectURL(urlInline);
                return;
            }
            const resp = await apiFetch(`/api/documents/${documentId}/summary/download`, { method: 'GET' });
            if (!resp.ok) {
                console.error('Failed to download summary', resp.status);
                alert('Failed to download summary.');
                return;
            }
            const blob = await resp.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `summary-${documentId}.txt`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        } catch (e) {
            console.error('Error while downloading summary', e);
            alert('Error while downloading summary.');
        }
    }

    async function runFullTextSearch() {
        if (!isLoggedIn()) return;
        const q = searchFullEl?.value.trim() || '';
        if (searchStatus) searchStatus.textContent = '';
        if (!q) {
            await load();
            return;
        }
        if (searchStatus) searchStatus.textContent = 'Searching...';
        try {
            const res = await apiFetch(`/api/search?q=${encodeURIComponent(q)}`);
            if (!res.ok) throw new Error(`Search failed (${res.status})`);
            docs = await res.json();
            render();
            if (searchStatus) searchStatus.textContent = `Found ${docs.length} result(s) for "${q}"`;
        } catch (e) {
            console.error(e);
            if (searchStatus) searchStatus.textContent = 'Search failed';
        }
    }

    searchEl?.addEventListener('input', render);
    searchFullBtn?.addEventListener('click', async (e) => { e.preventDefault(); await runFullTextSearch(); });
    searchFullEl?.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            await runFullTextSearch();
        }
    });
    refreshBtn?.addEventListener('click', load);

    const formEl = document.getElementById('uploadForm');
    formEl?.addEventListener('submit', async (e) => {
        e.preventDefault();
        msgEl.textContent = '';
        const file = fileInput.files[0];
        if (!file) { msgEl.textContent = 'Please choose a PDF file.'; return; }
        if (!/pdf$/i.test(file.type) && !/\.pdf$/i.test(file.name)) {
            msgEl.textContent = 'Only PDF files are allowed.';
            return;
        }
        const fd = new FormData();
        fd.append('file', file);
        if (titleInput.value) fd.append('title', titleInput.value);

        try {
            const res = await apiFetch('/api/documents/upload', { method: 'POST', body: fd });
            console.log(res);
            if (res.status === 403) {
                // delete jwt token
                console.log("deleting jwt");
                localStorage.removeItem('jwt');
                // send user to login page
                applyAuthState();
                console.log("should show login");
            }
            if (!res.ok) throw new Error('Upload failed');
            const created = await res.json();
            if (!created.createdAt) created.createdAt = new Date().toISOString();
            docs.unshift(created);
            render();
            formEl.reset();
            msgEl.textContent = 'Upload successful';
        } catch (err) {
            console.error(err);
            msgEl.textContent = 'Upload failed (backend endpoint not yet available or error).';
        }
    });

    // Auto-refresh support
    let autoRefreshTimer = null;
    function startAutoRefresh(intervalMs = 10000) {
        // Refresh every 10s by default while tab is visible and user is logged in
        stopAutoRefresh();
        autoRefreshTimer = setInterval(() => {
            if (document.visibilityState === 'visible' && isLoggedIn()) {
                load();
            }
        }, intervalMs);
        document.addEventListener('visibilitychange', () => {
            // Trigger a refresh immediately when returning to the tab
            if (document.visibilityState === 'visible' && isLoggedIn()) {
                load();
            }
        });
    }
    function stopAutoRefresh() {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = null;
        }
    }

    // Comments functionality
    async function loadComments(documentId) {
        if (!isLoggedIn()) return;

        const commentsContainer = document.getElementById(`comments-${documentId}`);
        if (!commentsContainer) return;

        try {
            const res = await apiFetch(`/api/documents/${documentId}/comments`);
            if (!res.ok) {
                commentsContainer.innerHTML = '<div class="muted">Failed to load comments.</div>';
                return;
            }

            const comments = await res.json();
            if (!comments || comments.length === 0) {
                commentsContainer.innerHTML = '<div class="muted">No comments yet.</div>';
                return;
            }

            let html = '';
            for (const comment of comments) {
                html += `
                <div class="comment" style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #0001;">
                    <div class="comment-text" style="margin-bottom: 0.25rem;">${escapeHtml(comment.text)}</div>
                    <div class="comment-meta row space-between">
                        <span class="muted date">${formatDate(comment.createdAt)}</span>
                        <button class="delete-comment-btn" data-comment-id="${comment.id}">Delete</button>
                    </div>
                </div>`;
            }

            commentsContainer.innerHTML = html;

            // Add event listeners for delete buttons
            const deleteButtons = commentsContainer.querySelectorAll('.delete-comment-btn');
            deleteButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    const commentId = btn.dataset.commentId;
                    if (!commentId) return;

                    if (!confirm('Delete this comment?')) return;

                    try {
                        const res = await apiFetch(`/api/comments/${commentId}`, { method: 'DELETE' });
                        if (res.ok) {
                            // Reload comments after deletion
                            loadComments(documentId);
                        } else {
                            alert('Failed to delete comment.');
                        }
                    } catch (e) {
                        console.error('Error deleting comment:', e);
                        alert('Error deleting comment.');
                    }
                });
            });

        } catch (e) {
            console.error('Error loading comments:', e);
            commentsContainer.innerHTML = '<div class="muted">Error loading comments.</div>';
        }
    }

    async function addComment(documentId) {
        if (!isLoggedIn()) return;

        const textArea = document.getElementById(`comment-text-${documentId}`);
        if (!textArea) return;

        const text = textArea.value.trim();
        if (!text) {
            alert('Please enter a comment.');
            return;
        }

        try {
            const res = await apiFetch(`/api/documents/${documentId}/comments`, {
                method: 'POST',
                body: JSON.stringify({ text })
            });

            if (!res.ok) {
                alert('Failed to add comment.');
                return;
            }

            // Clear the textarea
            textArea.value = '';

            // Reload comments to show the new one
            loadComments(documentId);

        } catch (e) {
            console.error('Error adding comment:', e);
            alert('Error adding comment.');
        }
    }

    // Init
    loadTheme();
    applyAuthState();
    // Trigger initial load and start periodic refresh
    load();
    startAutoRefresh(10000);
</script>
</body>
</html>

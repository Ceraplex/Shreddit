<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shreddit ‚Äî Dashboard</title>
    <style>
        :root { color-scheme: light dark; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; margin: 0; }
        header { padding: 1rem; background: #222; color: #fff; display:flex; align-items:center; justify-content:space-between; }
        main { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; padding: 1rem; }
        .card { background: #ffffff; border: 1px solid #0002; border-radius: 8px; padding: 1rem; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { padding: .75rem; border-bottom: 1px solid #0001; display: flex; flex-direction: column; align-items: stretch; gap: .5rem; }
        .muted { opacity: .8; }
        .toolbar { display: flex; gap: .5rem; margin-bottom: .75rem; }
        input, button { padding: .5rem .75rem; }
        .title { font-weight: 600; }
        .row { display: flex; align-items: center; gap: .5rem; }
        .date { font-variant-numeric: tabular-nums; }
        .space-between { justify-content: space-between; width: 100%; }
        .title-btn { background: none; border: none; color: inherit; cursor: pointer; padding: 0; font: inherit; text-align: left; }
        .details { display: none; margin-top: .5rem; padding-top: .5rem; border-top: 1px solid #0002; }
        .right { display:flex; gap:.5rem; align-items:center; }

        /* Theme toggle styles */
        #themeToggle { padding: .4rem .6rem; border-radius: 6px; border: 1px solid #0002; background: transparent; color: inherit; cursor: pointer; }

        /* Light/Dark Theme Overrides */
        body.theme-light { background: #f7f7f7; color: #111; }
        body.theme-dark { background: #121212; color: #eee; }

        body.theme-light header { background: #f0f0f0; color: #111; }
        body.theme-dark header { background: #222; color: #fff; }

        body.theme-light .card { background: #ffffff; border-color: #0002; }
        body.theme-dark .card { background: #1e1e1e; border-color: #ffffff22; }

        body.theme-light li { border-bottom-color: #0002; }
        body.theme-dark li { border-bottom-color: #ffffff22; }

        body.theme-light .details { border-top-color: #0002; }
        body.theme-dark .details { border-top-color: #ffffff33; }

        /* Form controls and buttons theming */
        input, select, textarea, button { font: inherit; }
        button:not(.title-btn) { cursor: pointer; }

        /* Light theme controls */
        body.theme-light input,
        body.theme-light select,
        body.theme-light textarea {
            background: #ffffff;
            color: #111;
            border: 1px solid #0002;
            border-radius: 6px;
        }
        body.theme-light button:not(.title-btn) {
            background: #f7f7f7;
            color: #111;
            border: 1px solid #0002;
            border-radius: 6px;
        }
        body.theme-light button:not(.title-btn):hover {
            background: #ececec;
        }

        /* Dark theme controls */
        body.theme-dark input,
        body.theme-dark select,
        body.theme-dark textarea {
            background: #2a2a2a;
            color: #eee;
            border: 1px solid #ffffff22;
            border-radius: 6px;
        }
        body.theme-dark button:not(.title-btn) {
            background: #2a2a2a;
            color: #eee;
            border: 1px solid #ffffff22;
            border-radius: 6px;
        }
        body.theme-dark button:not(.title-btn):hover {
            background: #333333;
        }

        /* Focus styles for accessibility */
        body.theme-light input:focus,
        body.theme-light select:focus,
        body.theme-light textarea:focus,
        body.theme-light button:not(.title-btn):focus {
            outline: 2px solid #6ca8ff;
            outline-offset: 1px;
        }
        body.theme-dark input:focus,
        body.theme-dark select:focus,
        body.theme-dark textarea:focus,
        body.theme-dark button:not(.title-btn):focus {
            outline: 2px solid #5b8cff;
            outline-offset: 1px;
        }

        /* Ensure theme toggle border adapts per theme */
        body.theme-dark #themeToggle { border-color: #ffffff22; }
        body.theme-light #themeToggle { border-color: #0002; }

        /* File input ‚ÄúDurchsuchen‚Äù button theming */
        /* Modern browsers */
        body.theme-light input[type="file"]::file-selector-button {
            background: #f7f7f7;
            color: #111;
            border: 1px solid #0002;
            border-radius: 6px;
            padding: .5rem .75rem;
            margin-right: .5rem;
            cursor: pointer;
        }
        body.theme-light input[type="file"]::file-selector-button:hover { background: #ececec; }
        body.theme-light input[type="file"]::file-selector-button:focus {
            outline: 2px solid #6ca8ff;
            outline-offset: 1px;
        }
        body.theme-dark input[type="file"]::file-selector-button {
            background: #2a2a2a;
            color: #eee;
            border: 1px solid #ffffff22;
            border-radius: 6px;
            padding: .5rem .75rem;
            margin-right: .5rem;
            cursor: pointer;
        }
        body.theme-dark input[type="file"]::file-selector-button:hover { background: #333333; }
        body.theme-dark input[type="file"]::file-selector-button:focus {
            outline: 2px solid #5b8cff;
            outline-offset: 1px;
        }

        /* WebKit fallback */
        body.theme-light input[type="file"]::-webkit-file-upload-button {
            background: #f7f7f7;
            color: #111;
            border: 1px solid #0002;
            border-radius: 6px;
            padding: .5rem .75rem;
            margin-right: .5rem;
            cursor: pointer;
        }
        body.theme-light input[type="file"]::-webkit-file-upload-button:hover { background: #ececec; }
        body.theme-light input[type="file"]::-webkit-file-upload-button:focus {
            outline: 2px solid #6ca8ff;
            outline-offset: 1px;
        }
        body.theme-dark input[type="file"]::-webkit-file-upload-button {
            background: #2a2a2a;
            color: #eee;
            border: 1px solid #ffffff22;
            border-radius: 6px;
            padding: .5rem .75rem;
            margin-right: .5rem;
            cursor: pointer;
        }
        body.theme-dark input[type="file"]::-webkit-file-upload-button:hover { background: #333333; }
        body.theme-dark input[type="file"]::-webkit-file-upload-button:focus {
            outline: 2px solid #5b8cff;
            outline-offset: 1px;
        }
    </style>
</head>
<body>
<header>
    <h1>Shreddit ‚Äî Documents</h1>
    <div class="right">
        <button id="themeToggle" aria-label="Toggle theme">üåô</button>
        <span id="userInfo" class="muted" style="display:none"></span>
        <button id="logoutBtn" style="display:none">Logout</button>
    </div>
</header>
<main>
    <section class="card" id="authCard" style="grid-column:1/3;">
        <h2>Log In or Register</h2>
        <form id="authForm">
            <div class="row">
                <input id="authUsername" placeholder="Username" required />
            </div>
            <div class="row">
                <input id="authPassword" type="password" placeholder="Password" required />
            </div>
            <div class="row" style="gap:.5rem">
                <button id="loginBtn">Log In</button>
                <button id="registerBtn" type="button">Register</button>
            </div>
            <div id="authMsg" class="muted" style="margin-top:.5rem"></div>
        </form>
    </section>

    <section class="card" id="listCard" style="display:none;">
        <div class="toolbar">
            <input id="search" placeholder="Filter by title..." />
            <button id="refresh">Refresh</button>
        </div>
        <ul id="list"></ul>
    </section>
    <section class="card" id="upload" style="display:none;">
        <h2>Upload Document</h2>
        <form id="uploadForm">
            <div class="row">
                <input id="title" name="title" placeholder="Title (optional)" />
            </div>
            <div class="row">
                <input id="file" name="file" type="file" accept="application/pdf,.pdf" required />
            </div>
            <div class="row">
                <button type="submit">Upload PDF</button>
            </div>
            <div class="row">
                <small class="muted">Only PDF files are allowed.</small>
            </div>
        </form>
        <div id="msg" class="muted" style="margin-top:.5rem"></div>
    </section>
</main>
<script src="/assets/api.js"></script>
<script>
    // Auth / UI gating
    const authCard = document.getElementById('authCard');
    const listCard = document.getElementById('listCard');
    const uploadCard = document.getElementById('upload');
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    const themeToggle = document.getElementById('themeToggle');

    function isLoggedIn() {
        try { return !!localStorage.getItem('jwt'); } catch (_) { return false; }
    }
    function getUsername() {
        try { return localStorage.getItem('username') || ''; } catch (_) { return ''; }
    }
    function setAuth(token, username) {
        try {
            localStorage.setItem('jwt', token);
            localStorage.setItem('username', username || '');
        } catch (_) {}
        applyAuthState();
    }
    function clearAuth() {
        try {
            localStorage.removeItem('jwt');
            localStorage.removeItem('username');
        } catch (_) {}
        applyAuthState();
    }
    function applyAuthState() {
        const logged = isLoggedIn();
        authCard.style.display = logged ? 'none' : 'block';
        listCard.style.display = logged ? 'block' : 'none';
        uploadCard.style.display = logged ? 'block' : 'none';
        userInfo.style.display = logged ? 'inline' : 'none';
        logoutBtn.style.display = logged ? 'inline-block' : 'none';
        if (logged) {
            userInfo.textContent = 'Signed in as ' + getUsername();
            load();
        } else {
            // clear list
            const listEl = document.getElementById('list');
            if (listEl) listEl.innerHTML = '';
        }
    }
    logoutBtn.addEventListener('click', () => { clearAuth(); });

    // Theme toggle
    function applyTheme(theme) {
        const mode = theme === 'dark' ? 'dark' : 'light';
        document.body.classList.remove('theme-light', 'theme-dark');
        document.body.classList.add('theme-' + mode);
        if (themeToggle) { themeToggle.textContent = mode === 'dark' ? '‚òÄÔ∏è' : 'üåô'; }
    }
    function loadTheme() {
        let t = 'light';
        try {
            t = localStorage.getItem('theme') || 'light';
        } catch (_) {}
        applyTheme(t);
    }
    themeToggle?.addEventListener('click', () => {
        const isDark = document.body.classList.contains('theme-dark');
        const next = isDark ? 'light' : 'dark';
        try { localStorage.setItem('theme', next); } catch (_) {}
        applyTheme(next);
    });

    // Auth handlers
    const authForm = document.getElementById('authForm');
    const authUsername = document.getElementById('authUsername');
    const authPassword = document.getElementById('authPassword');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const authMsg = document.getElementById('authMsg');

    loginBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await doAuth('/api/auth/login');
    });
    registerBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await doAuth('/api/auth/register');
    });
    async function doAuth(url) {
        authMsg.textContent = '';
        const username = authUsername.value.trim();
        const password = authPassword.value;
        if (!username || !password) { authMsg.textContent = 'Enter username and password.'; return; }
        try {
            const res = await apiFetch(url, { method: 'POST', body: JSON.stringify({ username, password }) });
            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                authMsg.textContent = data.error || 'Authentication failed';
                return;
            }
            const data = await res.json();
            setAuth(data.token, data.username);
            authForm.reset();
        } catch (e) {
            console.error(e);
            authMsg.textContent = 'Network error';
        }
    }

    // Documents/dashboard (same as before)
    const listEl = document.getElementById('list');
    const searchEl = document.getElementById('search');
    const refreshBtn = document.getElementById('refresh');
    const form = document.getElementById('uploadForm');
    const titleInput = document.getElementById('title');
    const fileInput = document.getElementById('file');
    const msgEl = document.getElementById('msg');
    let docs = [];

    async function load() {
        if (!isLoggedIn()) return;
        try {
            const res = await apiFetch('/api/documents');
            if (res.status === 403) {
                // delete jwt token
                console.log("deleting jwt");
                localStorage.removeItem('jwt');
                // send user to login page
                applyAuthState();
                console.log("should show login");
            }
            if (!res.ok) throw new Error('Failed to load documents');
            docs = await res.json();
            render();
        } catch (e) {
            console.error(e);
            listEl.innerHTML = `<li class="muted">Error loading documents</li>`;
        }
    }

    function render() {
        const q = (searchEl?.value || '').toLowerCase();
        const filtered = docs.filter(d => (d.title || '').toLowerCase().includes(q));
        listEl.innerHTML = '';
        if (!filtered.length) {
            listEl.innerHTML = `<li class="muted">No documents</li>`;
            return;
        }
        for (const d of filtered) {
            const li = document.createElement('li');
            const left = document.createElement('div');
            left.className = 'row';
            left.innerHTML = `<button class="title-btn title" data-id="${d.id}">${escapeHtml(d.title || '(untitled)')}</button><span class="muted date">${formatDate(d.createdAt)}</span>`;

            const del = document.createElement('button');
            del.textContent = 'Delete';
            del.onclick = async () => {
                if (!confirm('Delete this document?')) return;
                const res = await apiFetch(`/api/documents/${d.id}`, { method: 'DELETE' });
                if (res.ok) {
                    docs = docs.filter(x => x.id !== d.id);
                    render();
                } else {
                    alert('Delete failed');
                }
            };

            const headerRow = document.createElement('div');
            headerRow.className = 'row space-between';
            headerRow.appendChild(left);
            headerRow.appendChild(del);

            const details = document.createElement('div');
            details.className = 'details';
            details.dataset.loaded = 'false';

            const titleBtn = headerRow.querySelector('.title-btn');
            titleBtn.addEventListener('click', async () => {
                if (details.style.display === 'block') {
                    details.style.display = 'none';
                    return;
                }
                if (details.dataset.loaded !== 'true') {
                    try {
                        const res = await apiFetch(`/api/documents/${d.id}`);
                        if (!res.ok) {
                            details.innerHTML = `<div class="muted">Details could not be loaded.</div>`;
                        } else {
                            const doc = await res.json();
                            details.innerHTML = `
                <div><strong>Title:</strong> ${escapeHtml(doc.title || '(untitled)')}</div>
                <div><strong>Uploaded:</strong> ${formatDate(doc.createdAt)}</div>
                <div><strong>ID:</strong> ${doc.id}</div>
              `;
                            details.dataset.loaded = 'true';
                        }
                    } catch (e) {
                        console.error(e);
                        details.innerHTML = `<div class="muted">Error loading details.</div>`;
                    }
                }
                details.style.display = 'block';
            });

            li.appendChild(headerRow);
            li.appendChild(details);
            listEl.appendChild(li);
        }
    }

    function formatDate(dt) {
        if (!dt) return '(no date)';
        try {
            const d = typeof dt === 'string' ? new Date(dt) : dt;
            if (Number.isNaN(d.getTime())) return '(no date)';
            return d.toLocaleString();
        } catch (_) { return '(no date)'; }
    }

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    searchEl?.addEventListener('input', render);
    refreshBtn?.addEventListener('click', load);

    const formEl = document.getElementById('uploadForm');
    formEl?.addEventListener('submit', async (e) => {
        e.preventDefault();
        msgEl.textContent = '';
        const file = fileInput.files[0];
        if (!file) { msgEl.textContent = 'Please choose a PDF file.'; return; }
        if (!/pdf$/i.test(file.type) && !/\.pdf$/i.test(file.name)) {
            msgEl.textContent = 'Only PDF files are allowed.';
            return;
        }
        const fd = new FormData();
        fd.append('file', file);
        if (titleInput.value) fd.append('title', titleInput.value);

        try {
            const res = await apiFetch('/api/documents/upload', { method: 'POST', body: fd });
            console.log(res);
            if (res.status === 403) {
                // delete jwt token
                console.log("deleting jwt");
                localStorage.removeItem('jwt');
                // send user to login page
                applyAuthState();
                console.log("should show login");
            }
            if (!res.ok) throw new Error('Upload failed');
            const created = await res.json();
            if (!created.createdAt) created.createdAt = new Date().toISOString();
            docs.unshift(created);
            render();
            formEl.reset();
            msgEl.textContent = 'Upload successful';
        } catch (err) {
            console.error(err);
            msgEl.textContent = 'Upload failed (backend endpoint not yet available or error).';
        }
    });

    // Init
    loadTheme();
    applyAuthState();
</script>
</body>
</html>
